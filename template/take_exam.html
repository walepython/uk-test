

{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="exam-interface">
    <!-- HEADER WITH TIMER AND PROGRESS -->
    <div class="exam-header">
        <div class="exam-info">
            <h1>{{ exam.title }}</h1>
            <div class="timer" id="timer">
                Time remaining: <span id="time-display">{{ time_limit|time:"i:s" }}</span>
            </div>
        </div>
        
        <div class="progress-info">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
            <div class="progress-text">
                Question <span id="current-question">1</span> of {{ total_questions }}
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT AREA -->
    <div class="exam-content">
        <!-- LEFT: QUESTION NAVIGATION -->
        <div class="question-nav">
            <div class="nav-header">Questions</div>
            <div class="questions-grid" id="questions-grid">
                {% for i in "x"|ljust:total_questions %}
                <button class="question-btn" data-question="{{ forloop.counter }}">
                    {{ forloop.counter }}
                </button>
                {% endfor %}
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <span class="legend-color correct"></span>
                    <span>Correct</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color review"></span>
                    <span>Review</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color incorrect"></span>
                    <span>Incorrect</span>
                </div>
            </div>
        </div>

        <!-- RIGHT: QUESTION AND ANSWERS -->
        <div class="question-area">
            <div class="question-card">
                <div class="question-header">
                    <h2 id="question-text">Loading question...</h2>
                    <button class="review-btn" id="review-btn">
                        <i class="far fa-flag"></i> Mark for Review
                    </button>
                </div>
                
                <div class="answers-container" id="answers-container">
                    <!-- Answers will be loaded here -->
                </div>
                
                <div class="question-footer">
                    <button class="nav-btn prev-btn" id="prev-btn">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <button class="nav-btn next-btn" id="next-btn">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                    <button class="submit-btn" id="submit-exam">
                        Submit Exam
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<div id="exam-data" 
     data-exam-id="{{ exam.id }}"
     data-attempt-id="{{ attempt.id }}"
     data-total-questions="{{ total_questions }}"
     data-time-limit="{{ time_limit }}"
     style="display: none;">
</div>

<style>
.exam-interface {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    font-family: Arial, sans-serif;
}

/* HEADER */
.exam-header {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.exam-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.exam-info h1 {
    color: #045cc3;
    margin: 0;
    font-size: 1.8rem;
}

.timer {
    background: #f8f9fa;
    padding: 10px 20px;
    border-radius: 5px;
    font-weight: bold;
    color: #d9534f;
    font-size: 1.1rem;
}

.progress-info {
    margin-top: 15px;
}

.progress-bar {
    height: 10px;
    background: #e9ecef;
    border-radius: 5px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress-fill {
    height: 100%;
    background: #4CAF50;
    transition: width 0.3s ease;
}

.progress-text {
    text-align: center;
    color: #666;
    font-size: 0.9rem;
}

/* MAIN CONTENT */
.exam-content {
    display: flex;
    gap: 20px;
    min-height: 600px;
}

/* QUESTION NAVIGATION */
.question-nav {
    flex: 0 0 250px;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.nav-header {
    font-weight: bold;
    color: #045cc3;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f0;
}

.questions-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-bottom: 20px;
}

.question-btn {
    width: 40px;
    height: 40px;
    border: 2px solid #dee2e6;
    background: white;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s ease;
}

.question-btn:hover {
    border-color: #045cc3;
    background: #f8f9fa;
}

.question-btn.active {
    background: #045cc3;
    color: white;
    border-color: #045cc3;
}

.question-btn.answered {
    background: #4CAF50;
    color: white;
    border-color: #4CAF50;
}

.question-btn.review {
    background: #FF9800;
    color: white;
    border-color: #FF9800;
}

.question-btn.incorrect {
    background: #f44336;
    color: white;
    border-color: #f44336;
}

.legend {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #f0f0f0;
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    font-size: 0.85rem;
    color: #666;
}

.legend-color {
    width: 15px;
    height: 15px;
    border-radius: 3px;
    margin-right: 10px;
}

.legend-color.correct { background: #4CAF50; }
.legend-color.review { background: #FF9800; }
.legend-color.incorrect { background: #f44336; }

/* QUESTION AREA */
.question-area {
    flex: 1;
}

.question-card {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    height: 100%;
}

.question-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #f0f0f0;
}

.question-header h2 {
    color: #2c3e50;
    margin: 0;
    font-size: 1.4rem;
    line-height: 1.5;
    flex: 1;
}

.review-btn {
    background: #FF9800;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.3s ease;
}

.review-btn:hover {
    background: #F57C00;
}

.review-btn.active {
    background: #f44336;
}

/* ANSWERS */
.answers-container {
    margin-bottom: 30px;
}

.answer-option {
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 15px 20px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
}

.answer-option:hover {
    border-color: #045cc3;
    background: #f8f9fa;
}

.answer-option.selected {
    border-color: #045cc3;
    background: #e3f2fd;
}

.answer-option input[type="radio"] {
    margin-right: 15px;
    transform: scale(1.2);
}

.answer-text {
    font-size: 1.1rem;
    color: #333;
    flex: 1;
}

/* NAVIGATION BUTTONS */
.question-footer {
    display: flex;
    justify-content: space-between;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 2px solid #f0f0f0;
}

.nav-btn {
    padding: 12px 25px;
    border: 2px solid #045cc3;
    background: white;
    color: #045cc3;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.nav-btn:hover {
    background: #045cc3;
    color: white;
}

.nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    border-color: #ccc;
    color: #ccc;
}

.nav-btn:disabled:hover {
    background: white;
    color: #ccc;
}

.submit-btn {
    padding: 12px 30px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.3s ease;
}

.submit-btn:hover {
    background: #388E3C;
}

/* RESPONSIVE */
@media (max-width: 1024px) {
    .exam-content {
        flex-direction: column;
    }
    
    .question-nav {
        flex: 0 0 auto;
    }
    
    .questions-grid {
        grid-template-columns: repeat(6, 1fr);
    }
}

@media (max-width: 768px) {
    .question-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .question-footer {
        flex-direction: column;
        gap: 10px;
    }
    
    .nav-btn, .submit-btn {
        width: 100%;
        justify-content: center;
    }
    
    .questions-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const examData = document.getElementById('exam-data');
    const examId = examData.dataset.examId;
    const attemptId = examData.dataset.attemptId;
    const totalQuestions = parseInt(examData.dataset.totalQuestions);
    const timeLimit = parseInt(examData.dataset.timeLimit);
    
    let currentQuestion = 1;
    let timerInterval;
    let timeRemaining = timeLimit;
    
    // Initialize timer
    startTimer();
    
    // Load first question
    loadQuestion(currentQuestion);
    
    // Timer function
    function startTimer() {
        updateTimerDisplay();
        timerInterval = setInterval(function() {
            timeRemaining--;
            updateTimerDisplay();
            
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                submitExam();
            }
        }, 1000);
    }
    
    function updateTimerDisplay() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        document.getElementById('time-display').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Update progress bar
        const progress = ((timeLimit - timeRemaining) / timeLimit) * 100;
        document.getElementById('progress-fill').style.width = `${progress}%`;
    }
    
    // Load question function
    async function loadQuestion(questionNumber) {
        try {
            const response = await fetch(
                `/page/exam/${examId}/question/${questionNumber}/?attempt_id=${attemptId}`
            );
            const data = await response.json();
            
            if (data.error) {
                console.error(data.error);
                return;
            }
            
            // Update question text
            document.getElementById('question-text').textContent = data.text;
            document.getElementById('current-question').textContent = questionNumber;
            
            // Update question buttons
            updateQuestionButtons(questionNumber, data.selected_answer, data.is_reviewed);
            
            // Update review button
            const reviewBtn = document.getElementById('review-btn');
            if (data.is_reviewed) {
                reviewBtn.classList.add('active');
                reviewBtn.innerHTML = '<i class="fas fa-flag"></i> Remove Review';
            } else {
                reviewBtn.classList.remove('active');
                reviewBtn.innerHTML = '<i class="far fa-flag"></i> Mark for Review';
            }
            
            // Create answer options
            const answersContainer = document.getElementById('answers-container');
            answersContainer.innerHTML = '';
            
            data.answers.forEach(answer => {
                const answerDiv = document.createElement('div');
                answerDiv.className = 'answer-option';
                if (data.selected_answer === answer.id) {
                    answerDiv.classList.add('selected');
                }
                
                answerDiv.innerHTML = `
                    <input type="radio" name="answer" value="${answer.id}" 
                           ${data.selected_answer === answer.id ? 'checked' : ''}
                           id="answer-${answer.id}">
                    <label class="answer-text" for="answer-${answer.id}">
                        ${answer.text}
                    </label>
                `;
                
                answerDiv.addEventListener('click', function() {
                    selectAnswer(answer.id);
                });
                
                answersContainer.appendChild(answerDiv);
            });
            
            // Update navigation buttons
            document.getElementById('prev-btn').disabled = questionNumber === 1;
            document.getElementById('next-btn').disabled = questionNumber === totalQuestions;
            
        } catch (error) {
            console.error('Error loading question:', error);
        }
    }
    
    function updateQuestionButtons(questionNumber, selectedAnswer, isReviewed) {
        const buttons = document.querySelectorAll('.question-btn');
        buttons.forEach(btn => {
            btn.classList.remove('active', 'answered', 'review', 'incorrect');
            
            if (parseInt(btn.dataset.question) === questionNumber) {
                btn.classList.add('active');
            }
            
            // Here you would check the answer status from server
            // This is simplified - you would need to track answer status
        });
    }
    
    async function selectAnswer(answerId) {
        try {
            const response = await fetch('/page/save-answer/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    attempt_id: attemptId,
                    question_id: document.getElementById('question-text').dataset.questionId,
                    answer_id: answerId
                })
            });
            
            const data = await response.json();
            if (data.success) {
                // Update UI
                const answerOptions = document.querySelectorAll('.answer-option');
                answerOptions.forEach(option => {
                    option.classList.remove('selected');
                    if (option.querySelector('input').value == answerId) {
                        option.classList.add('selected');
                    }
                });
            }
        } catch (error) {
            console.error('Error saving answer:', error);
        }
    }
    
    // Navigation
    document.getElementById('prev-btn').addEventListener('click', function() {
        if (currentQuestion > 1) {
            currentQuestion--;
            loadQuestion(currentQuestion);
        }
    });
    
    document.getElementById('next-btn').addEventListener('click', function() {
        if (currentQuestion < totalQuestions) {
            currentQuestion++;
            loadQuestion(currentQuestion);
        }
    });
    
    // Question grid navigation
    document.querySelectorAll('.question-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentQuestion = parseInt(this.dataset.question);
            loadQuestion(currentQuestion);
        });
    });
    
    // Review button
    document.getElementById('review-btn').addEventListener('click', async function() {
        const isReview = !this.classList.contains('active');
        
        try {
            const response = await fetch('/page/save-answer/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    attempt_id: attemptId,
                    question_id: document.getElementById('question-text').dataset.questionId,
                    is_reviewed: isReview
                })
            });
            
            const data = await response.json();
            if (data.success) {
                this.classList.toggle('active');
                if (isReview) {
                    this.innerHTML = '<i class="fas fa-flag"></i> Remove Review';
                } else {
                    this.innerHTML = '<i class="far fa-flag"></i> Mark for Review';
                }
            }
        } catch (error) {
            console.error('Error saving review:', error);
        }
    });
    
    // Submit exam
    document.getElementById('submit-exam').addEventListener('click', function() {
        if (confirm('Are you sure you want to submit the exam? You cannot change answers after submitting.')) {
            submitExam();
        }
    });
    
    async function submitExam() {
        clearInterval(timerInterval);
        
        try {
            window.location.href = `/page/exam/${examId}/results/${attemptId}/`;
        } catch (error) {
            console.error('Error submitting exam:', error);
        }
    }
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}